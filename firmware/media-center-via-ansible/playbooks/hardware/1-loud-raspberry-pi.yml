- name: Hardware
  hosts: raspberry
  become: true

  tasks:

  - name: Patch config.txt
    lineinfile:
      dest: "{{ config_path }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
    loop:
    - { regexp: '^dtoverlay=w5500', line: 'dtoverlay=w5500' }
    - { regexp: '^dtoverlay=max98357a-overlay', line: 'dtoverlay=max98357a-overlay,sdmode-pin=4' }

  # Disable HDMI audio output
  - name: Disable HDMI audio
    replace:
      dest: "{{ config_path }}"
      regexp: "{{ item.regexp }}"
      replace: "{{ item.line }}"
    loop:
    - { regexp: '^dtparam=audio=on', line: '#dtparam=audio=on' }


  # Requires reboot due to hardaware configuration changes
  - name: Reboot the machine (Wait for 5 min)
    reboot:
      reboot_timeout: 300